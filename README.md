# MongoDB Slow Query Detection System

Node.js + MongoDB ν™κ²½μ—μ„ μ¬λ΅μ° μΏΌλ¦¬λ¥Ό μ‹¤μ‹κ°„μΌλ΅ νƒμ§€ν•κ³  λ΅κΉ…ν•λ” κ°λ°μ© μ‹μ¤ν…μ…λ‹λ‹¤.

## μ£Όμ” κΈ°λ¥

- **μ‹¤μ‹κ°„ μΏΌλ¦¬ λ¨λ‹ν„°λ§**: MongoDBμ λ¨λ“  μΏΌλ¦¬ μ‹¤ν–‰ μ‹κ°„μ„ μ‹¤μ‹κ°„μΌλ΅ μ¶”μ 
- **μ¬λ΅μ° μΏΌλ¦¬ νƒμ§€**: μ„¤μ •λ μ„κ³„κ°’μ„ μ΄κ³Όν•λ” μΏΌλ¦¬λ¥Ό μλ™μΌλ΅ κ°μ§€ν•κ³  κ²½κ³ 
- **μƒμ„Έν• μΏΌλ¦¬ μ •λ³΄**: μ»¬λ ‰μ…λ…, ν•„ν„° μ΅°κ±΄, aggregation pipeline λ“± μƒμ„Έ μ •λ³΄ μ κ³µ
- **μ„±λ¥ μµμ ν™”**: λ΅κΉ… μ‹μ¤ν… μμ²΄κ°€ μ• ν”λ¦¬μΌ€μ΄μ… μ„±λ¥μ— λ―ΈμΉλ” μν–¥ μµμ†ν™”
- **κ°€λ…μ„± λ†’μ€ λ΅κ·Έ**: pino-prettyλ¥Ό ν†µν• μ»¬λ¬ν’€ν•κ³  μ½κΈ° μ‰¬μ΄ λ΅κ·Έ μ¶λ ¥

## ν”„λ΅μ νΈ κµ¬μ΅°

```
β”β”€β”€ server.js                    # λ©”μΈ μ„λ²„ μ‹¤ν–‰ νμΌ
β”β”€β”€ src/
β”‚   β”β”€β”€ app.js                  # Koa μ•± μ„¤μ • λ° λ―Έλ“¤μ›¨μ–΄ κµ¬μ„±
β”‚   β”β”€β”€ config/
β”‚   β”‚   β”β”€β”€ logger.js           # Pino λ΅κ±° μ„¤μ •
β”‚   β”‚   β””β”€β”€ database.js         # MongoDB ν΄λΌμ΄μ–ΈνΈ + μΏΌλ¦¬ λ¨λ‹ν„°λ§
β”‚   β”β”€β”€ middleware/
β”‚   β”‚   β””β”€β”€ mongo.js            # MongoDB μ—°κ²° λ―Έλ“¤μ›¨μ–΄
β”‚   β””β”€β”€ routes/
β”‚       β””β”€β”€ api.js              # ν…μ¤νΈμ© API λΌμ°νΈ
β”β”€β”€ seed.js                     # ν…μ¤νΈ λ°μ΄ν„° μƒμ„± μ¤ν¬λ¦½νΈ
β””β”€β”€ .env                        # ν™κ²½ λ³€μ μ„¤μ •
```

## π›  μ„¤μΉ λ° μ‹¤ν–‰

### 1. μμ΅΄μ„± μ„¤μΉ

```bash
npm install
```

### 2. ν™κ²½ λ³€μ μ„¤μ •

`.env` νμΌμ„ μƒμ„±ν•κ³  λ‹¤μ μ„¤μ •μ„ μ¶”κ°€ν•μ„Έμ”:

```env
# MongoDB μ—°κ²° URI
MONGO_URI=mongodb://localhost:27017

# μ¬λ΅μ° μΏΌλ¦¬ νƒμ§€ μ„¤μ •
SLOW_LOGGING=true
SLOW_QUERY_THRESHOLD=200

# λ΅κΉ… μ„¤μ •
LOG_LEVEL=info
LOG_DEST=./app.log

# ν…μ¤νΈμ© μ§€μ—° μ‹κ°„ (ms) - κ°λ°/ν…μ¤νΈ μ‹μ—λ§ μ‚¬μ©
SIMULATED_DELAY=0

# μ„λ²„ ν¬νΈ
PORT=3000
```

### 3. ν…μ¤νΈ λ°μ΄ν„° μƒμ„± (μ„ νƒμ‚¬ν•­)

```bash
node seed.js
```

### 4. μ„λ²„ μ‹¤ν–‰

```bash
node server.js
```

## ν…μ¤νΈ API μ—”λ“ν¬μΈνΈ

μ„λ²„ μ‹¤ν–‰ ν›„ λ‹¤μ μ—”λ“ν¬μΈνΈλ΅ μΏΌλ¦¬λ¥Ό ν…μ¤νΈν•  μ μμµλ‹λ‹¤:

```bash
# μ„±μΈ μ‚¬μ©μ μ΅°ν (find μΏΌλ¦¬)
curl http://localhost:3000/api/users/adults

# λ§¤μ¶ μƒμ„ μƒν’ μ΅°ν (aggregate μΏΌλ¦¬)
curl http://localhost:3000/api/orders/top-sales

# μ›”λ³„ μμµ λ¶„μ„ (λ³µμ΅ν• aggregate μΏΌλ¦¬)
curl http://localhost:3000/api/analytics/monthly-revenue
```

## λ΅κ·Έ μ¶λ ¥ μμ‹

<img width="691" height="157" alt="image" src="https://github.com/user-attachments/assets/f7c28194-e6f9-47bf-881b-09db8f20ffda" />

### μΌλ° μΏΌλ¦¬
```
[2025-07-20 15:30:25] INFO: find on users (45ms) filter={"age":{"$gte":18}}
```

### μ¬λ΅μ° μΏΌλ¦¬
```
[2025-07-20 15:30:26] WARN: SLOW: aggregate on orders (250ms) pipeline=$matchβ†’$groupβ†’$sortβ†’$limit
```

### μΏΌλ¦¬ μ‹¤ν¨
```
[2025-07-20 15:30:27] ERROR: find on users FAILED
```

## μ»¤μ¤ν„°λ§μ΄μ§•

### 1. μ¬λ΅μ° μΏΌλ¦¬ μ„κ³„κ°’ λ³€κ²½

```env
SLOW_QUERY_THRESHOLD=100  # 100ms μ΄μƒμ„ μ¬λ΅μ° μΏΌλ¦¬λ΅ κ°„μ£Ό
```

## μ£Όμμ‚¬ν•­

1. **κ°λ° ν™κ²½ μ „μ©**: μ΄ μ‹μ¤ν…μ€ κ°λ°/ν…μ¤νΈ ν™κ²½μ—μ„μ μ‚¬μ©μ„ κ¶μ¥ν•©λ‹λ‹¤.
2. **ν”„λ΅λ•μ… μ‚¬μ© μ‹**: ν”„λ΅λ•μ…μ—μ„ μ‚¬μ©ν•  κ²½μ° λ΅κ·Έ λ λ²¨μ„ μ΅°μ •ν•κ³  ν•„μ”ν• λ³΄μ• κ²€ν† λ¥Ό μν–‰ν•μ„Έμ”.
3. **λ©”λ¨λ¦¬ μ‚¬μ©λ‰**: λ€λ‰μ μΏΌλ¦¬κ°€ λ°μƒν•λ” ν™κ²½μ—μ„λ” λ©”λ¨λ¦¬ μ‚¬μ©λ‰μ„ λ¨λ‹ν„°λ§ν•μ„Έμ”.

## μμ΅΄μ„±

- **Node.js**: 18+
- **MongoDB**: 4.0+
- **μ£Όμ” ν¨ν‚¤μ§€**:
  - `koa` - μ›Ή ν”„λ μ„μ›ν¬
  - `mongodb` - MongoDB λ“λΌμ΄λ²„
  - `pino` - κ³ μ„±λ¥ λ΅κ±°
  - `pino-pretty` - λ΅κ·Έ ν¬λ§¤ν„°
